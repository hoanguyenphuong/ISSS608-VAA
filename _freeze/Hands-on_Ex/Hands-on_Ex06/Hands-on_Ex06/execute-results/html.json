{
  "hash": "1e8085e472112d2e7d4ee0e97070d808",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-on_Ex06 - Visualising and Analysing Time-oriented Data \"\nauthor: \"Hoa Nguyen Phuong\"\nformat: html\ndate-modified: \"last-modified\" \nexecute:\n  echo: true \n  eval: true \n  warning: false \n  freeze: true\n---\n\n\n\n# [1]{style=\"color:mediumvioletred\"} Learning Objectives\n\nIn this chapter, we will learn to plot the following visualisations:\n\n-   a calender heatmap (ggplot2 functions)\n-   a cycle plot (ggplot2 functions)\n-   a slopegraph\n-   a horizon chart\n\n# [2]{style=\"color:mediumvioletred\"} Getting Started\n\nTo install and launch the following R packages:\n\n**scales, viridis, lubridate, ggthemes, gridExtra, readxl, knitr, data.table and tidyverse.**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(scales, viridis, lubridate, ggthemes, gridExtra, readxl, knitr, \n               data.table, tidyverse, CGPfunctions, ggHoriPlot)\n```\n:::\n\n\n\n# [3]{style=\"color:mediumvioletred\"} Plotting Calendar Heatmap\n\nWithin this section, we will do the following:\n\n-   plot a calendar heatmap by using ggplot2 functions and extension\n-   write function using R programming\n-   derive specific date and time related field by using base **R** and **libridate** packages\n-   perform data preparation task by using tidyr and dplyr packages\n\n## [3.1]{style=\"color:mediumvioletred\"} Data\n\n*eventlog.csv* file will be used for this exercise. This data file consists of 199,999 rows of time-series cyber attack records by country.\n\n::::::::: panel-tabset\n## **1-Import data**\n\nTo import *eventlog.csv* into R environment and call this data frame as ***attacks.***\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nattacks <- read_csv(\"data/eventlog.csv\")\n```\n:::\n\n\n\n## **2-Exam data structure**\n\nWe will use `kable()` to review the structure of the imported data frame.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(head(attacks))\n```\n\n::: {.cell-output-display}\n\n\n|timestamp           |source_country |tz              |\n|:-------------------|:--------------|:---------------|\n|2015-03-12 15:59:16 |CN             |Asia/Shanghai   |\n|2015-03-12 16:00:48 |FR             |Europe/Paris    |\n|2015-03-12 16:02:26 |CN             |Asia/Shanghai   |\n|2015-03-12 16:02:38 |US             |America/Chicago |\n|2015-03-12 16:03:22 |CN             |Asia/Shanghai   |\n|2015-03-12 16:03:45 |CN             |Asia/Shanghai   |\n\n\n:::\n:::\n\n\n\nWe see 3 columns: *timestamp, source_country,* and *tz.*\n\n-   *timestamp:* stores data-time values in POSIXct format.\n-   *source_country:* stores the source of attack. It is in ISO3166-1 alpha-2 country code.\n-   *tz:* stores timezone of source IP address.\n\n## **3-Data prep**\n\n**Step 1.** Deriving *weekday* and *hour of day* fields\n\nTwo new fields need to be derived: ***wkday*** and ***hour*** before we plot the calendar heatmap.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nmake_hr_wkday <- function(ts, sc, tz) {\n  real_times <- ymd_hms(ts,\n                        tz = tz[1],\n                        quiet = TRUE)\n  dt <- data.table(source_country = sc,\n                   wkday = weekdays(real_times),\n                   hour = hour(real_times))\n  return(dt)\n}\n```\n:::\n\n\n\n::::: goals\n::: goals-header\nLearning from the code\n:::\n\n::: goals-container\n-   [`ymd_hms()`](https://lubridate.tidyverse.org/reference/ymd_hms.html) and [`hour()`](https://lubridate.tidyverse.org/reference/hour.html) are from [**lubridate**](https://lubridate.tidyverse.org/) package.\n\n-   [`weekdays()`](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/weekdays) is a **base** R function.\n:::\n:::::\n\n**Step 2.** Deriving the attacks tibble data frame\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nwkday_levels <- c('Saturday', 'Friday', 'Thursday',\n                  'Wednesday', 'Tuesday', 'Monday',\n                  'Sunday')\nattacks <- attacks %>%\n  group_by(tz) %>%\n  do(make_hr_wkday(.$timestamp,\n                   .$source_country,\n                   .$tz)) %>%\n  ungroup() %>%\n  mutate(wkday = factor(\n    wkday, levels = wkday_levels),\n    hour = factor(\n      hour, levels = 0:23\n    )\n  )\n```\n:::\n\n\n\n::::: goals\n::: goals-header\nLearning from the code\n:::\n\n::: goals-container\n`mutate()` of **dplyr** package is used to convert *wkday* and *hour* fields into **factor** so they will be ordered when plotting.\n:::\n:::::\n\n**Step 3.** Check the tibble table:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(head(attacks))\n```\n\n::: {.cell-output-display}\n\n\n|tz           |source_country |wkday    |hour |\n|:------------|:--------------|:--------|:----|\n|Africa/Cairo |BG             |Saturday |20   |\n|Africa/Cairo |TW             |Sunday   |6    |\n|Africa/Cairo |TW             |Sunday   |8    |\n|Africa/Cairo |CN             |Sunday   |11   |\n|Africa/Cairo |US             |Sunday   |15   |\n|Africa/Cairo |CA             |Monday   |11   |\n\n\n:::\n:::\n\n\n:::::::::\n\n## [3.2]{style=\"color:mediumvioletred\"} Build the calendar heatmaps\n\nWe can simply group the count by hour and wkday and plot it, since we know that we have values for every combination. Use the code below to build the calendar heatmaps:\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\ngrouped <- attacks %>%\n  count(wkday, hour) %>%\n  ungroup() %>%\n  na.omit()\n\nggplot(grouped,\n       aes(hour,\n           wkday,\n           fill = n)) +\n  geom_tile(color = \"#f1f4f5\",\n            size = 0.1) +\n  theme_tufte(base_family = \"Helvetica\") +\n  coord_equal() +\n  scale_fill_gradient(name = \"# of attacks\",\n                      low = \"#faf1f0\",\n                      high = \"dark red\") +\n  labs(x = NULL,\n       y = NULL,\n       title = \"Attacks by weekday and time of day\") +\n  theme(axis.ticks = element_blank(),\n        plot.title = element_text(hjust = 0.5),\n        legend.title = element_text(size = 8),\n        legend.text = element_text(size = 6))\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex06_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n::::: goals\n::: goals-header\nLearning from the code\n:::\n\n::: goals-container\n-   a tibble data table called grouped is derived by aggregating the attack by *wkday* and *hour* fields.\n-   a new field called *n* is derived by using group_by() and count() functions.\n-   `na.omit()` is used to exclude missing value.\n-   `geom_tile()` is used to plot tiles (grids) at each x and y position. `color` and `size` arguments are used to specify the border color and line size of the tiles.\n-   [`theme_tufte()`](https://jrnold.github.io/ggthemes/reference/theme_tufte.html) of [**ggthemes**](https://jrnold.github.io/ggthemes/reference/index.html) package is used to remove unnecessary chart junk. *\\[there is a dashed line around the plot removed by this theme\\]*\n-   `coord_equal()` is used to ensure the plot will have an aspect ratio of 1:1.\n-   `scale_fill_gradient()` function is used to create a **two colour gradient** (low-high).\n:::\n:::::\n\n## [3.3]{style=\"color:mediumvioletred\"} Build multiple calendar heatmaps\n\n**Challenge:** Build multiple heatmaps for the top four countries with the highest number of attacks.\n\n**Step 1.** Derive attack numbers by country object\n\nTo identify the top 4 countries with the highest attack numbers, we need to do the following:\n\n-   count the number of attacks by country\n-   calculate the percentage of attacks by country\n-   save the result in a tibble data frame\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nattacks_by_country <- count(\n  attacks, source_country) %>%\n  mutate(percent = percent(n/sum(n))) %>%\n  arrange(desc(n))\n```\n:::\n\n\n\n**Step 2.** Prepare the tidy data frame\n\nNow, we will extract the top 4 countries from ***attacks*** data frame, and save the data in a new tibble data frame *top4_attacks.*\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\ntop4 <- attacks_by_country$source_country[1:4]\ntop4_attacks <- attacks %>%\n  filter(source_country %in% top4) %>%\n  count(source_country, wkday, hour) %>%\n  ungroup() %>%\n  mutate(source_country = factor(\n    source_country, levels = top4\n  )) %>%\n  na.omit()\n```\n:::\n\n\n\n**Step 3.** Plot the multiple calendar heatmap with ggplot2\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nggplot(top4_attacks,\n       aes(hour,\n           wkday,\n           fill = n)) +\n  geom_tile(color = \"#f1f4f5\", size = 0.1) +\n  theme_tufte(base_family = \"Helvetica\") +\n  coord_equal() +\n  scale_fill_gradient(name = \"# of attacks\",\n                      low = \"#faf1f0\",\n                      high = \"dark red\") +\n  facet_wrap(~source_country, ncol = 2) +\n  labs(x = NULL, y = NULL,\n       title = \"Attacks on top 4 countries by weekday and time of day\") +\n  theme(axis.ticks = element_blank(),\n        axis.text.x = element_text(size = 4),\n        axis.text.y = element_text(size = 4),\n        plot.title = element_text(size = 10, hjust = 0.5),\n        legend.title = element_text(size = 8),\n        legend.text = element_text(size = 6))\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex06_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n# [4]{style=\"color:mediumvioletred\"} Plotting Cycle Plot\n\nTo show time-series patterns and trend of visitor arrivals from Vietnam, we will use Cycle plot to visualise it with **ggplot2**.\n\n## [4.1]{style=\"color:mediumvioletred\"} Data\n\n::: panel-tabset\n## **1 Data import**\n\nWe will use dataset from *arrivals_by_air.xlsx*. Since it's in .xlsx format, `read_excel()` will be used to the read the file.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nair <- read_excel(\"data/arrivals_by_air.xlsx\")\n```\n:::\n\n\n\n## **2 Deriving M and Y fields**\n\nHere 2 new fields called *month* and *year* are derived from *Month-Year* field.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nair$month <- factor(month(air$'Month-Year'),\n                    levels = 1:12,\n                    labels = month.abb,\n                    ordered = TRUE)\nair$year <- year(ymd(air$'Month-Year'))\n```\n:::\n\n\n\n## **3 Extract target country**\n\nNow, we will extract data for the target country - Vietnam\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvietnam <- air %>%\n  select(`Vietnam`,\n         month,\n         year) %>%\n  filter(year >= 2010)\n```\n:::\n\n\n\n## **4 Compute year avg arrival by month**\n\nThen we use `group_by()` and `summarise()` of **dplyr** to compute year average arrivals by month.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhline.data <- vietnam %>%\n  group_by(month) %>%\n  summarise(avgvalue = mean(`Vietnam`))\n```\n:::\n\n\n:::\n\n## [4.2]{style=\"color:mediumvioletred\"} Plotting the cycle plot\n\nNow plot the Cycle plot.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nggplot() +\n  geom_line(data = vietnam,\n            aes(x = year,\n                y = `Vietnam`,\n                group = month),\n            colour = \"black\") +\n  geom_hline(aes(yintercept = avgvalue),\n             data = hline.data,\n             linetype = 6,\n             colour = \"red\",\n             size = 0.5) +\n  facet_grid(~month) +\n  labs(axis.text.x = element_blank(),\n       title = \"Visitor arrivals from VN by air, Jan 2010 - Dec 2019\") +\n  xlab(\"\") +\n  ylab(\"# of Visitors\") +\n  theme_tufte(base_family = \"Helvetica\") +\n  theme(axis.text.x = element_text(size = 3))\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex06_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n# [5]{style=\"color:mediumvioletred\"} Plotting Slopegraph\n\nEnsure **CGPfunctions** has been installed and loaded onto R environment before plot a [slopegraph](https://www.storytellingwithdata.com/blog/2020/7/27/what-is-a-slopegraph). Refer to [Using newggslopegraph](https://cran.r-project.org/web/packages/CGPfunctions/vignettes/Using-newggslopegraph.html) to learn more about the function, and read more about `newggslopegraph()` and its arguments in this [link](https://www.rdocumentation.org/packages/CGPfunctions/versions/0.6.3/topics/newggslopegraph).\n\nSlopegraphs are not the best choice for categorical data when there’s no real connection between the selected categories.\n\n## [5.1]{style=\"color:mediumvioletred\"} Data import\n\nLet's import the data first:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrice <- read_csv(\"data/rice.csv\")\n```\n:::\n\n\n\nTake a look at the data structure:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(head(rice))\n```\n\n::: {.cell-output-display}\n\n\n|Country | Year| Yield| Production|\n|:-------|----:|-----:|----------:|\n|China   | 1961| 20787|   56217601|\n|China   | 1962| 23700|   65675288|\n|China   | 1963| 26833|   76439280|\n|China   | 1964| 28289|   85853780|\n|China   | 1965| 29667|   90705630|\n|China   | 1966| 31445|   98403990|\n\n\n:::\n:::\n\n\n\n## [5.2]{style=\"color:mediumvioletred\"} Plotting the slopegraph\n\n::::::::: panel-tabset\n## Rice\n\nNow, we will plot the slopegraph to know the ups and down of the 11 Asian countries.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\nrice %>%\n  mutate(Year = factor(Year)) %>%\n  filter(Year %in% c(1961, 1980)) %>%\n  newggslopegraph(Year, Yield, Country,\n                  Title = \"Rice Yield of Top 11 Asian Countries\",\n                  SubTitle = \"1961-1980\",\n                  Caption = \"Prepared by Cathy C.\",\n                  DataLabelLineSize = 0.2,\n                  DataLabelFillColor = \"#EFDCAB\") +\n  theme_wsj() +\n  theme(plot.title = element_text(size = 15),\n        plot.subtitle = element_text(size = 11),\n        plot.caption = element_text(size = 11),\n        legend.text = element_text(size = 8),\n        legend.title = element_text(size = 8),\n        axis.text.y = element_text(size = 8, color = \"grey70\"))\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex06_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n::::: goals\n::: goals-header\nLearning from the code\n:::\n\n::: goals-container\n-   The first letter of `Title` `SubTitle` `Caption` need to have upper case letter.\n-   For effective data visualisation design, `factor()` is used to convert the value type of *Year* field from numeric to **factor**.\n:::\n:::::\n\n## Arrivals\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\narrival <- read_xlsx(\"data/arrivals_by_air.xlsx\")\nkable(head(arrival))\n```\n\n::: {.cell-output-display}\n\n\n|Month-Year | Republic of South Africa| Canada|   USA| Bangladesh| Brunei| China| Hong Kong SAR (China)| India| Indonesia| Japan| South Korea| Kuwait| Malaysia| Myanmar| Pakistan| Philippines| Saudi Arabia| Sri Lanka| Taiwan| Thailand| United Arab Emirates| Vietnam| Belgium & Luxembourg|  CIS| Finland| France| Germany| Ireland| Italy| Netherlands| Spain| Switzerland| United Kingdom| Australia| New Zealand|\n|:----------|------------------------:|------:|-----:|----------:|------:|-----:|---------------------:|-----:|---------:|-----:|-----------:|------:|--------:|-------:|--------:|-----------:|------------:|---------:|------:|--------:|--------------------:|-------:|--------------------:|----:|-------:|------:|-------:|-------:|-----:|-----------:|-----:|-----------:|--------------:|---------:|-----------:|\n|2000-01-01 |                     3291|   5545| 25906|       2883|   3749| 33895|                 13692| 19235|     65151| 59288|       21457|    507|    27472|    1177|     2150|        8404|         1312|      3922|  15766|    12048|                 1318|    1527|                 1434| 2703|    1634|   4752|   12739|    1292|  3544|        4962|   925|        3731|          28986|     34616|        5034|\n|2000-02-01 |                     2357|   6120| 28262|       2469|   3236| 34344|                 19870| 18975|     37105| 58188|       19634|    199|    29084|    1161|     2496|        9128|          623|      3988|  24861|    12745|                  899|    2269|                 1596| 1182|    1297|   6391|   13093|    1200|  2897|        5054|   747|        3980|          35148|     26030|        3938|\n|2000-03-01 |                     4036|   6255| 30439|       2904|   3342| 27053|                 17086| 21049|     44205| 74426|       20719|    386|    30504|    1355|     2429|       11691|         1578|      4259|  18767|    16971|                 1474|    2034|                 1548| 1088|    1220|   5528|   13645|    1368|  2717|        4950|   935|        3576|          36117|     31119|        4668|\n|2000-04-01 |                     4241|   4521| 25378|       2843|   5117| 30464|                 22346| 26160|     45480| 49985|       17489|    221|    34478|    1593|     2711|       14141|          705|      6579|  22735|    20397|                 1284|    2420|                 1592| 1012|    1208|   5544|   13366|    1345|  2512|        4149|   941|        3850|          33792|     34824|        6890|\n|2000-05-01 |                     2841|   3914| 26163|       2793|   4152| 30775|                 16357| 35869|     38350| 48937|       19398|    164|    34795|    1397|     2594|       13305|          679|      4625|  18399|    15769|                 1042|    1833|                 1167|  660|     743|   4225|   10878|    1067|  2205|        3643|   764|        3025|          23377|     33139|        7006|\n|2000-06-01 |                     2776|   3487| 28179|       3146|   5018| 26720|                 18133| 31314|     47982| 53798|       17522|    440|    34660|    1715|     2924|       10555|         2749|      4740|  21042|    17217|                 1545|    2480|                 1170|  712|     982|   4047|    9054|    1363|  2196|        3544|   855|        2580|          21769|     35731|        7634|\n\n\n:::\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Show the code\"}\narrival_trans <- arrival %>%\n  mutate(year = year(`Month-Year`)) %>%\n  group_by(year) %>%\n  summarise(across(where(is.numeric), sum, na.rm = TRUE))\n\n#head(arrival_trans)\narrival_long <- arrival_trans %>%\n  mutate(year = as.ordered(year)) %>%\n  pivot_longer(\n    cols = -year,\n    names_to = \"Country\",\n    values_to = \"Count\"\n  ) %>%\n  filter(year %in% c(2000, 2005))  %>%\n  group_by(Country) %>%\n  ungroup()\n\n\nggplot_obj <- newggslopegraph(\n  dataframe = arrival_long,\n  Times = year,\n  Measurement = Count,\n  Grouping = Country,\n  Title = \"Arrival Times by Country\",\n  SubTitle = \"2000-2025\",\n  Caption = \"Prepared by Cathy C.\",)\n\nggplot_obj \n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex06_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n::::: goals\n::: goals-header\nLearning from the code\n:::\n\n::: goals-container\n-   `newggslopegraph()` prefers an ordered sequence for its Times variable to ensure the correct chronological display of data points.\n:::\n:::::\n:::::::::\n\n# Reference\n\n-   Kam, T. S. (2025). R for Visual Analytics. Retrieved February 24, 2025, from \\[<https://r4va.netlify.app/chap17>\\]\n\n-   Powell, C. (2025). Slopegraph in ggplot2. Retrieved February 24, 2025, from <https://r-charts.com/evolution/newggslopegraph/>\n",
    "supporting": [
      "Hands-on_Ex06_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}